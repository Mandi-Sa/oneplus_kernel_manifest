name: Test Kernel Manifest

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-manifest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Repo Tool
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+rx ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Clean Workspace
        run: |
          rm -rf kernel_platform
          rm -rf .repo

      - name: Initialize Repo
        run: |
          repo init -u https://github.com/wanwei1028/kernel_manifest.git -b main -m oneplus_13.xml

      - name: Retry Repo Sync
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 30
          max_attempts: 3
          command: |
            repo sync -j4 --force-sync --no-clone-bundle

      - name: Validate Symbolic Links
        run: |
          cd kernel_platform
          [ -L WORKSPACE ] || { echo "❌ WORKSPACE link missing"; exit 1; }
          [ -L build_with_bazel.py ] || { echo "❌ build_with_bazel.py link missing"; exit 1; }
          echo "✅ All symbolic links are valid"
